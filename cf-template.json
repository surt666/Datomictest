{"Description":"Datomic Transactor Template",
 "Mappings":
 {"AWSInstanceType2Arch":
  {"m1.xlarge":{"Arch":"64"},
   "c1.medium":{"Arch":"64"},
   "m1.large":{"Arch":"64"},
   "cc1.4xlarge":{"Arch":"64"},
   "m2.xlarge":{"Arch":"64"},
   "m2.2xlarge":{"Arch":"64"},
   "m2.4xlarge":{"Arch":"64"},
   "c1.xlarge":{"Arch":"64"},
   "t1.micro":{"Arch":"64"},
   "m1.small":{"Arch":"64"}},
  "AWSRegionArch2AMI":{"us-east-1":{"64":"ami-a2e742cb"}}},
 "Parameters":
 {"Xmx":
  {"Description":"Xmx setting for the JVM",
   "AllowedPattern":"\\d+[GgMm]",
   "Type":"String",
   "Default":"1572m"},
  "InstanceType":
  {"Description":"Type of EC2 instance to launch",
   "Type":"String",
   "Default":"m1.small"},
  "InstanceMonitoring":
  {"Description":"Detailed monitoring for store instances?",
   "Type":"String",
   "Default":"true"},
  "GroupSize":
  {"Description":"Size of machine group",
   "Type":"String",
   "Default":1},
  "SecurityGroups":
  {"Default":"datomic",
   "Description":"Preexisting security groups.",
   "Type":"CommaDelimitedList"},
  "DatomicDeployBucket":
  {"Default":"deploy-a0dbc565-faf2-4760-9b7e-29a8e45f428e",
   "Type":"String"},
  "DatomicVersion":{"Default":"0.8.3435", "Type":"String"}},
 "Resources":
 {"LaunchGroup":
  {"Type":"AWS::AutoScaling::AutoScalingGroup",
   "Properties":
   {"AvailabilityZones":{"Fn::GetAZs":""},
    "LaunchConfigurationName":{"Ref":"LaunchConfig"},
    "MaxSize":{"Ref":"GroupSize"},
    "MinSize":{"Ref":"GroupSize"}}},
  "LaunchConfig":
  {"Type":"AWS::AutoScaling::LaunchConfiguration",
   "Properties":
   {"InstanceType":{"Ref":"InstanceType"},
    "SecurityGroups":{"Ref":"SecurityGroups"},
    "InstanceMonitoring":{"Ref":"InstanceMonitoring"},
    "BlockDeviceMappings":
    [{"VirtualName":"ephemeral0", "DeviceName":"\/dev\/sdb"}],
    "ImageId":
    {"Fn::FindInMap":
     ["AWSRegionArch2AMI", {"Ref":"AWS::Region"},
      {"Fn::FindInMap":
       ["AWSInstanceType2Arch", {"Ref":"InstanceType"}, "Arch"]}]},
    "UserData":
    {"Fn::Base64":
     {"Fn::Join":
      ["\n",
       ["exec > >(tee \/var\/log\/user-data.log|logger -t user-data -s 2>\/dev\/console) 2>&1",
        {"Fn::Join":["=", ["export XMX", {"Ref":"Xmx"}]]},
        {"Fn::Join":
         ["=",
          ["export DATOMIC_DEPLOY_BUCKET",
           {"Ref":"DatomicDeployBucket"}]]},
        {"Fn::Join":
         ["=", ["export DATOMIC_VERSION", {"Ref":"DatomicVersion"}]]},
        "cd \/datomic", "cat <<EOF >aws.properties",
        "host=`curl http:\/\/169.254.169.254\/latest\/meta-data\/local-ipv4`",
        "alt-host=`curl http:\/\/169.254.169.254\/latest\/meta-data\/public-ipv4`",
        "protocol=ddb\naws-dynamodb-peer-user=datomic-aws-dynamodb-peer-1\naws-cloudwatch-user=datomic-aws-cloudwatch-1\naws-s3-log-bucket-id=datomic-logs-5033b44e-daa8-4893-92aa-b874fb0becf0\naws-dynamodb-secret-key=ivrLkXbhgVV6\/rhDHdCc4ls1C5BR7H2g+DXD2xHA\naws-dynamodb-access-key-id=AKIAJHV4Z5JSWG5JDANA\naws-cloudwatch-secret-key=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\naws-s3-log-access-key-id=AKIAJSV5MCMB2BNCAXPQ\nport=4334\naws-dynamodb-user=datomic-aws-dynamodb-1\naws-s3-log-secret-key=0\/DnXvlWvQrWphjiDGxS08hE8XAIjpY0+Zl3+T6j\naws-dynamodb-peer-access-key-id=AKIAIWWUQM2X3I2Z3PIQ\naws-cloudwatch-dimension-value=datomic-1\naws-dynamodb-table=datomic\nlicense-key=ZggqYZOmJ0obhCCvoCl\/5ta+FYH4bguNqngVGJ7UBueTLQvBJ+8NjIwGyW5Q1PybWbhCBMX8NBlfC2s0sEG9xvvFW\/tifiKS2CbM4ECr4XAELBhfF6QUfoP3tJ6KAcOBT93zqpsXimlAT8Dqh5yLfFkn6zJIbkkcIgev7aKF\/7Qw3e8pKk\/K+CWKB69wC\/G7p3M0r\/yaO0uVW5Z\/WYEzM\/1qExOtCLVOUUQ+PQ2bs+9T8NXWddHfDP3DsMwKWdXxRLwbsNpy1CFs99vq8gPanqc5AxxqDziBOsCqgUuqbEAasOyP6cHOJ4Z5jLuoq5uKKGAw74\/e\/Ak7JD1jwX3l4Q==\naws-dynamodb-peer-secret-key=tYJp5tFWRNyupZ4j+w3LpmUgHZdPfxr\/JZZu+SpX\naws-cloudwatch-access-key-id=AKIAJSHQTZTXDFZQ6F6Q\naws-s3-log-user=datomic-aws-s3-log-1",
        "EOF", "chmod 744 aws.properties",
        "EC2_ACCESS_KEY=\"${DATOMIC_READ_DEPLOY_ACCESS_KEY_ID}\" EC2_SECRET_KEY=\"${DATOMIC_READ_DEPLOY_AWS_SECRET_KEY}\" perl bin\/aws get \"${DATOMIC_DEPLOY_BUCKET}\/${DATOMIC_VERSION}\/startup.sh\" > startup.sh",
        "chmod 500 startup.sh", ".\/startup.sh"]]}}}}}}